name: OrcidSwift

on:
  push:
    branches: ["main"]
    tags:
      - "v*"
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      run_integration_tests:
        description: "Run ORCID integration tests (hits the internet)"
        type: boolean
        default: false
      build_xcframework:
        description: "Build XCFramework artifact"
        type: boolean
        default: false
      publish_release_assets:
        description: "Upload XCFramework to GitHub Release (requires tag trigger or run with a tag ref)"
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_test:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4

      - name: Show toolchain
        run: |
          swift --version
          xcodebuild -version

      - name: SwiftPM build
        run: swift build -v

      - name: SwiftPM unit tests
        run: swift test -v

      - name: SwiftPM integration tests (opt-in)
        if: ${{ inputs.run_integration_tests == true }}
        env:
          ORCIDSWIFT_RUN_INTEGRATION_TESTS: "1"
        run: swift test -v --filter OrcidSwiftIntegrationTests

  xcframework:
    runs-on: macos-26
    needs: build_and_test
    if: ${{ inputs.build_xcframework == true || startsWith(github.ref, 'refs/tags/v') }}
    steps:
      - uses: actions/checkout@v4

      - name: Set variables
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          NAME="OrcidSwift"
          VERSION="${GITHUB_REF_NAME:-dev}"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

            - name: Build XCFramework (SwiftPM archive, iOS + Simulator)
          shell: bash
          run: |
            set -euo pipefail

            NAME="${{ steps.vars.outputs.name }}"
            OUT_DIR="artifacts"
            DERIVED="DerivedData"

            rm -rf "$OUT_DIR" "$DERIVED"
            mkdir -p "$OUT_DIR" "$DERIVED"

            WORKSPACE=".swiftpm/xcode/package.xcworkspace"

            if [[ ! -d "$WORKSPACE" ]]; then
              echo "Missing SwiftPM Xcode workspace at $WORKSPACE"
              echo "Repo root is: $(pwd)"
              ls -la
              exit 1
            fi

            IOS_ARCHIVE_PATH="$DERIVED/${NAME}-iOS.xcarchive"
            SIM_ARCHIVE_PATH="$DERIVED/${NAME}-iOSSim.xcarchive"

            echo "Archiving iOS..."
            xcodebuild archive \
              -workspace "$WORKSPACE" \
              -scheme "$NAME" \
              -configuration Release \
              -destination "generic/platform=iOS" \
              -archivePath "$IOS_ARCHIVE_PATH" \
              SKIP_INSTALL=NO \
              BUILD_LIBRARY_FOR_DISTRIBUTION=YES

            echo "Archiving iOS Simulator..."
            xcodebuild archive \
              -workspace "$WORKSPACE" \
              -scheme "$NAME" \
              -configuration Release \
              -destination "generic/platform=iOS Simulator" \
              -archivePath "$SIM_ARCHIVE_PATH" \
              SKIP_INSTALL=NO \
              BUILD_LIBRARY_FOR_DISTRIBUTION=YES

            IOS_FRAMEWORK="$IOS_ARCHIVE_PATH/Products/Library/Frameworks/${NAME}.framework"
            SIM_FRAMEWORK="$SIM_ARCHIVE_PATH/Products/Library/Frameworks/${NAME}.framework"

            if [[ ! -d "$IOS_FRAMEWORK" || ! -d "$SIM_FRAMEWORK" ]]; then
              echo "Could not find archived frameworks."
              echo "IOS_FRAMEWORK=$IOS_FRAMEWORK"
              echo "SIM_FRAMEWORK=$SIM_FRAMEWORK"
              echo "--- iOS archive tree (top):"
              find "$IOS_ARCHIVE_PATH" -maxdepth 4 -type d | head -n 200
              echo "--- Sim archive tree (top):"
              find "$SIM_ARCHIVE_PATH" -maxdepth 4 -type d | head -n 200
              exit 1
            fi

            echo "Creating XCFramework..."
            xcodebuild -create-xcframework \
              -framework "$IOS_FRAMEWORK" \
              -framework "$SIM_FRAMEWORK" \
              -output "$OUT_DIR/${NAME}.xcframework"

            echo "Zipping..."
            ditto -c -k --sequesterRsrc --keepParent \
              "$OUT_DIR/${NAME}.xcframework" \
              "$OUT_DIR/${NAME}.xcframework.zip"

            shasum -a 256 "$OUT_DIR/${NAME}.xcframework.zip" | awk '{print $1}' \
              > "$OUT_DIR/${NAME}.xcframework.zip.sha256"

      - name: Upload XCFramework artifact
        uses: actions/upload-artifact@v4
        with:
          name: OrcidSwift-xcframework
          path: |
            artifacts/*.zip
            artifacts/*.sha256

  release_assets:
    runs-on: macos-26
    needs: xcframework
    if: ${{ (inputs.publish_release_assets == true || startsWith(github.ref, 'refs/tags/v')) && (inputs.build_xcframework == true || startsWith(github.ref, 'refs/tags/v')) }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: OrcidSwift-xcframework
          path: artifacts

      - name: Create GitHub Release (if needed) and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.zip
            artifacts/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
